<div class="mat-elevation-z4 dynamic-table-wrapper">
  <!-- Filter Input -->
  <div *ngIf="enableFilter" class="filter-wrapper">
    <mat-form-field appearance="outline" floatLabel="auto" class="full-width">
      <mat-label>Search</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Type to search..." />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>
  </div>

  <!-- Scrollable Table Wrapper -->
  <div class="table-scroll-container">
    <table mat-table [dataSource]="dataSource" matSort class="full-width mat-table-custom">

      <!-- ✅ S.No Column -->
      <ng-container matColumnDef="sno">
        <th mat-header-cell *matHeaderCellDef class="table-header">S.No</th>
        <td mat-cell *matCellDef="let row; let i = index">
          {{ getSerialNumber(i) }}
        </td>
      </ng-container>
      
      <!-- Dynamic Column Definitions -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column" [ngSwitch]="column">
        
        <!-- Actions Column -->
        <ng-container *ngSwitchCase="'Actions'">
          <th mat-header-cell *matHeaderCellDef class="table-header">Actions</th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button color="accent" (click)="onEdit(row)" matTooltip="Edit">
              <mat-icon>edit</mat-icon>
            </button>
            <button *ngIf="showAssignTechnician"
                    mat-icon-button color="warn"
                    (click)="onAssignTechnician(row)"
                    matTooltip="Assign Technician">
              <mat-icon>person</mat-icon>
            </button>
            <!-- AMC Button -->
            <button *ngIf="showAmcButton" 
                    mat-stroked-button color="primary"
                    class="amc-button"
                    (click)="onAmc(row)"
                    matTooltip="Update AMC">
              <mat-icon>settings</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Completed Column (Dropdown + Save button) -->
        <ng-container *ngSwitchCase="'Completed'">
          <th mat-header-cell *matHeaderCellDef class="table-header">Completed Status</th>
          <td mat-cell *matCellDef="let row">
            <mat-form-field appearance="outline" class="completed-dropdown">
              <mat-select
                placeholder="Select"
                [(ngModel)]="selectedCompletion[row.id || data.indexOf(row)]"
                (selectionChange)="onCompletionChange(row, $event.value)">
                <mat-option value="Completed">Completed</mat-option>
                <mat-option value="Pending">Pending</mat-option>
              </mat-select>
            </mat-form-field>

            <button mat-raised-button color="primary"
                    (click)="onSaveCompletion(row)"
                    [disabled]="!selectedCompletion[row.id || data.indexOf(row)]">
              UPDATE
            </button>
          </td>
        </ng-container>

        <!-- Other Columns -->
        <ng-container *ngSwitchDefault>
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="table-header">
            {{ column | formatHeader }}
          </th>
          <td mat-cell *matCellDef="let row">{{ row[column] }}</td>
        </ng-container>

      </ng-container>

      <!-- No Data Row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="columns.length + 1" style="text-align:center;">
          No data found.
        </td>
      </tr>

      <!-- ✅ Updated Header and Row Definitions -->
     <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>


    </table>
  </div>

  <!-- Paginator -->
  <mat-paginator *ngIf="enablePagination"
                 [pageSizeOptions]="[5, 10, 20]"
                 showFirstLastButtons>
  </mat-paginator>
</div>
